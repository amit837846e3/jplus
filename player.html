<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>JioTV Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }
    .shaka-video-container {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
    .shaka-spinner-container,
    .shaka-spinner,
    .shaka-spinner-svg {
      display: none !important;
    }
    /* Focus styles for remote navigation */
    .shaka-controls-button:focus,
    .shaka-overflow-menu button:focus,
    .shaka-seek-bar-container:focus {
      outline: 3px solid red;
      outline-offset: 2px;
    }
    /* Zoom/fit controls */
    .zoom-controls {
      position: absolute;
      bottom: 80px;
      right: 20px;
      z-index: 100;
      display: none;
    }
    .zoom-controls button {
      background: rgba(0,0,0,0.7);
      color: white;
      border: 1px solid #fff;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 4px;
      font-size: 14px;
    }
    .zoom-controls button:focus {
      background: rgba(255,0,0,0.7);
    }
  </style>
</head>
<body>
  <div class="shaka-video-container" id="player" data-shaka-player data-shaka-controls>
    <video autoplay muted playsinline></video>
    <div class="zoom-controls" id="zoomControls">
      <button id="fitScreen">Fit to Screen</button>
      <button id="zoomIn">Zoom In</button>
      <button id="zoomOut">Zoom Out</button>
      <button id="zoomReset">Reset Zoom</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const config = JSON.parse(localStorage.getItem("streamConfig"));
      if (!config || !config.mpd) {
        alert("Missing stream config");
        return;
      }

      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        alert("Shaka Player not supported");
        return;
      }

      const video = document.querySelector("video");
      const container = document.getElementById("player");
      const player = new shaka.Player(video);
      const ui = new shaka.ui.Overlay(player, container, video);
      
      // Zoom state management
      let zoomState = {
        scale: 1,
        x: 0,
        y: 0,
        isZoomed: false
      };

      // Configure UI for TV remote control
      ui.configure({
        controlPanelElements: [
          'play_pause', 'time_and_duration', 'mute', 'volume', 'spacer',
          'quality', 'language', 'picture_in_picture', 'fullscreen'
        ],
        addBigPlayButton: true,
        seekBarColors: {
          base: 'rgba(255,255,255,.2)',
          buffered: 'rgba(255,255,255,.4)',
          played: 'rgb(255,0,0)'
        },
        enableKeyboardForDebug: false,
        doubleClickForFullscreen: false,
        overflowMenuButtons: ['quality', 'language'],
        fadeDelay: 3, // Controls hide after 3 seconds of inactivity
        autoHide: true
      });

      player.configure({
        drm: { clearKeys: config.drm },
        streaming: {
          bufferingGoal: 30,
          rebufferingGoal: 5,
          bufferBehind: 30,
          retryParameters: {
            timeout: 15000,
            maxAttempts: 3,
            baseDelay: 500,
            backoffFactor: 1.5
          },
          segmentRequestTimeout: 10000,
        },
        manifest: {
          retryParameters: {
            timeout: 10000,
            maxAttempts: 2
          }
        }
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers["Referer"] = config.referer;
        request.headers["User-Agent"] = config.userAgent;
        request.headers["Cookie"] = config.token;

        if (
          (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
           type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
          !request.uris[0].includes("__hdnea__=")
        ) {
          const sep = request.uris[0].includes("?") ? "&" : "?";
          request.uris[0] += sep + config.token;
        }
      });

      try {
        await player.load(config.mpd);
        // Auto unmute after short delay
        setTimeout(() => {
          if (video.muted) {
            video.muted = false;
          }
        }, 1000);
        await video.play();
      } catch (e) {
        console.error("Playback error:", e);
      }

      // Zoom/fit functions
      function applyZoom() {
        video.style.transform = `scale(${zoomState.scale}) translate(${zoomState.x}px, ${zoomState.y}px)`;
        video.style.transformOrigin = 'center center';
      }

      function fitToScreen() {
        const videoRatio = video.videoWidth / video.videoHeight;
        const screenRatio = window.innerWidth / window.innerHeight;
        
        if (videoRatio > screenRatio) {
          // Video is wider than screen (pillarbox)
          zoomState.scale = window.innerWidth / video.videoWidth;
        } else {
          // Video is taller than screen (letterbox)
          zoomState.scale = window.innerHeight / video.videoHeight;
        }
        
        zoomState.x = 0;
        zoomState.y = 0;
        zoomState.isZoomed = false;
        applyZoom();
      }

      function zoomIn() {
        zoomState.scale += 0.1;
        zoomState.isZoomed = true;
        applyZoom();
      }

      function zoomOut() {
        if (zoomState.scale > 0.2) {
          zoomState.scale -= 0.1;
          zoomState.isZoomed = true;
          applyZoom();
        }
      }

      function resetZoom() {
        zoomState.scale = 1;
        zoomState.x = 0;
        zoomState.y = 0;
        zoomState.isZoomed = false;
        applyZoom();
      }

      // Initialize zoom controls
      const zoomControls = document.getElementById('zoomControls');
      document.getElementById('fitScreen').addEventListener('click', fitToScreen);
      document.getElementById('zoomIn').addEventListener('click', zoomIn);
      document.getElementById('zoomOut').addEventListener('click', zoomOut);
      document.getElementById('zoomReset').addEventListener('click', resetZoom);

      // TV remote control enhancements
      let lastInteractionTime = Date.now();
      let controlsVisible = true;

      function showControls() {
        ui.getControls().show();
        controlsVisible = true;
        lastInteractionTime = Date.now();
      }

      function checkHideControls() {
        if (controlsVisible && Date.now() - lastInteractionTime > 3000) {
          ui.getControls().hide();
          controlsVisible = false;
          zoomControls.style.display = 'none';
        }
      }

      // Check every second if controls should hide
      setInterval(checkHideControls, 1000);

      document.addEventListener('keydown', (e) => {
        showControls();
        
        // Show/hide zoom controls when menu button is pressed
        if (e.key === 'ContextMenu' || e.key === 'Menu') {
          zoomControls.style.display = zoomControls.style.display === 'block' ? 'none' : 'block';
          return;
        }

        // Map remote control keys to player actions
        switch (e.key) {
          case 'ArrowUp':
            if (zoomControls.style.display === 'block') {
              document.activeElement.previousElementSibling?.focus();
            } else {
              video.volume = Math.min(video.volume + 0.1, 1);
            }
            break;
          case 'ArrowDown':
            if (zoomControls.style.display === 'block') {
              document.activeElement.nextElementSibling?.focus();
            } else {
              video.volume = Math.max(video.volume - 0.1, 0);
            }
            break;
          case 'ArrowLeft':
            video.currentTime = Math.max(video.currentTime - 10, 0);
            break;
          case 'ArrowRight':
            video.currentTime = Math.min(video.currentTime + 10, video.duration);
            break;
          case 'Enter':
          case ' ':
            if (video.paused) video.play();
            else video.pause();
            break;
          case 'Backspace':
          case 'Escape':
            if (zoomControls.style.display === 'block') {
              zoomControls.style.display = 'none';
            } else if (ui.getControls().isOverflowMenuVisible()) {
              ui.getControls().hideOverflowMenu();
            } else if (document.fullscreenElement) {
              document.exitFullscreen();
            }
            break;
          case 'f':
          case 'F':
          case 'Fullscreen':
            if (!document.fullscreenElement) {
              container.requestFullscreen();
            } else {
              document.exitFullscreen();
            }
            break;
          case 'm':
          case 'M':
            video.muted = !video.muted;
            break;
        }
      });

      // Ensure controls are focusable for remote navigation
      document.addEventListener('focusin', () => {
        showControls();
      });

      // Initial fit to screen
      video.addEventListener('loadedmetadata', fitToScreen);
      window.addEventListener('resize', fitToScreen);
    });
  </script>
</body>
</html>
